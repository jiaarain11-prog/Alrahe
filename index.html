<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alrahe Label - Order Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* (kept your original CSS ‚Äî unchanged) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F4ECD8 0%, #E8DCC4 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .nav { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
        .nav-btn { padding:12px 24px; background:white; border:2px solid #C4A574; border-radius:10px; color:#C4A574; font-weight:600; cursor:pointer; transition:all .3s; }
        .nav-btn.active { background: linear-gradient(135deg,#C4A574 0%,#8B7355 100%); color:white; }
        .container { background:white; border-radius:20px; padding:30px; max-width:900px; margin:0 auto; box-shadow:0 20px 60px rgba(0,0,0,.15); }
        .header { text-align:center; margin-bottom:30px; }
        .brand-name { font-size:32px; font-weight:700; background:linear-gradient(135deg,#C4A574 0%,#8B7355 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:5px; }
        .subtitle { color:#666; font-size:14px; }
        .view { display:none; }
        .view.active { display:block; }
        .form-group { margin-bottom:20px; }
        label { display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px; }
        input, select { width:100%; padding:12px 15px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px; transition:all .3s ease; font-family:inherit; }
        input:focus, select:focus { outline:none; border-color:#C4A574; box-shadow:0 0 0 3px rgba(196,165,116,0.1); }
        .order-items { border:2px solid #F4ECD8; border-radius:15px; padding:20px; margin-bottom:20px; }
        .order-item { background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px; position:relative; }
        .order-item h4 { margin-bottom:15px; color:#C4A574; display:flex; justify-content:space-between; align-items:center; }
        .remove-item-btn { background:#f44336; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-size:14px; }
        .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .add-item-btn { width:100%; padding:12px; background:white; border:2px dashed #C4A574; color:#C4A574; border-radius:10px; cursor:pointer; font-weight:600; margin-bottom:20px; }
        .btn { width:100%; padding:15px; background:linear-gradient(135deg,#C4A574 0%,#8B7355 100%); color:white; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:transform .2s ease; margin-top:10px; }
        .btn:hover { transform:translateY(-2px); }
        .btn:disabled { opacity:.6; cursor:not-allowed; }
        .btn-secondary { background:white; color:#C4A574; border:2px solid #C4A574; }
        .success-message, .error-message, .info-message { display:none; padding:15px; border-radius:10px; text-align:center; margin-top:20px; animation:slideIn .3s ease; position:fixed; top:20px; right:20px; z-index:2000; min-width:300px; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,.15); }
        .success-message { background:#4caf50; color:white; }
        .error-message { background:#f44336; color:white; }
        .info-message { background:#2196F3; color:white; }
        .success-message.show, .error-message.show, .info-message.show { display:block; }
        .loading { display:none; text-align:center; color:#C4A574; margin-top:10px; }
        .loading.show { display:block; }
        .dashboard-controls { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
        .dashboard-controls select, .dashboard-controls button { flex:1; min-width:150px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-bottom:30px; }
        .stat-card { background:linear-gradient(135deg,#F4ECD8 0%,#E8DCC4 100%); padding:20px; border-radius:15px; text-align:center; }
        .stat-value { font-size:28px; font-weight:700; color:#C4A574; margin-bottom:5px; }
        .stat-label { color:#666; font-size:13px; }
        .chart-container { margin-bottom:30px; background:#f9f9f9; padding:20px; border-radius:15px; }
        .expense-section { background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px; }
        .expense-section h3 { margin-bottom:15px; color:#333; display:flex; justify-content:space-between; align-items:center; }
        .add-expense-btn { width:40px; height:40px; background:#C4A574; color:white; border:none; border-radius:50%; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .expense-list { max-height:300px; overflow-y:auto; }
        .expense-item { background:white; padding:12px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
        .expense-info { flex:1; }
        .expense-date { font-size:12px; color:#666; }
        .expense-description { font-weight:600; margin:5px 0; }
        .expense-amount { color:#C4A574; font-weight:700; font-size:18px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; overflow-y:auto; }
        .modal.show { display:flex; }
        .modal-content { background:white; padding:30px; border-radius:20px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto; margin:20px; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .modal-header h2 { color:#333; }
        .close-btn { background:none; border:none; font-size:28px; cursor:pointer; color:#666; }
        .settings-table { width:100%; border-collapse:collapse; margin-bottom:20px; }
        .settings-table th, .settings-table td { padding:10px; text-align:left; border-bottom:1px solid #e0e0e0; font-size:14px; }
        .settings-table th { background:#F4ECD8; font-weight:600; }
        .settings-table input { width:100%; padding:6px 8px; font-size:13px; }
        .settings-row { background:#f9f9f9; margin-bottom:15px; padding:15px; border-radius:10px; }
        .settings-row h4 { color:#C4A574; margin-bottom:10px; }
        .checkbox-group { display:flex; align-items:center; gap:10px; margin-top:10px; }
        .checkbox-group input[type="checkbox"] { width:auto; }
        .orders-table-container { overflow-x:auto; margin-bottom:20px; }
        .orders-table { width:100%; border-collapse:collapse; min-width:800px; }
        .orders-table th, .orders-table td { padding:12px; text-align:left; border-bottom:1px solid #e0e0e0; font-size:14px; }
        .orders-table th { background:#F4ECD8; font-weight:600; position:sticky; top:0; z-index:10; }
        .orders-table tr:hover { background:#f9f9f9; }
        .orders-table input, .orders-table select { width:100%; padding:6px 8px; font-size:13px; }
        .order-id { font-weight:600; color:#C4A574; }
        .status-badge { padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; display:inline-block; }
        .status-production { background:#cfe2ff; color:#084298; }
        .status-stitching { background:#fff3cd; color:#856404; }
        .status-delivered { background:#d4edda; color:#155724; }
        .save-order-btn { background:#C4A574; color:white; border:none; padding:6px 16px; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600; }
        .save-order-btn:hover { background:#8B7355; }
        .filter-section { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
        .filter-section input, .filter-section select { flex:1; min-width:150px; }
        @keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
        @media (max-width:600px) {
            .container { padding:20px; }
            .row { grid-template-columns:1fr; }
            .dashboard-controls { flex-direction:column; }
            .stats-grid { grid-template-columns:1fr; }
            .settings-table { font-size:12px; }
        }
    </style>
</head>
<body>
    <div class="nav">
        <button class="nav-btn active" onclick="switchView('order')">New Order</button>
        <button class="nav-btn" onclick="switchView('myorders')">My Orders</button>
        <button class="nav-btn" onclick="switchView('dashboard')">Dashboard</button>
    </div>

    <div class="container">
        <div class="header">
            <div class="brand-name">Alrahe Label</div>
            <div class="subtitle">Order Management System</div>
        </div>

        <!-- ORDER ENTRY VIEW -->
        <div id="orderView" class="view active">
            <form id="orderForm">
                <div class="form-group">
                    <label for="orderDate">Date</label>
                    <input type="date" id="orderDate" required>
                </div>

                <div class="form-group">
                    <label for="clientName">Client Name</label>
                    <input type="text" id="clientName" placeholder="Enter client name" required>
                </div>

                <div class="order-items" id="orderItems">
                    <h3 style="margin-bottom: 15px; color: #333;">Order Items</h3>
                    <!-- Items will be added here -->
                </div>

                <button type="button" class="add-item-btn" onclick="addOrderItem()">+ Add Another Dress</button>

                <div class="form-group">
                    <label for="advancePayment">Advance Payment (PKR)</label>
                    <input type="number" id="advancePayment" placeholder="Enter advance amount" required min="0">
                </div>

                <button type="submit" class="btn" id="submitBtn">Submit Order</button>
            </form>

            <div class="loading" id="loading">Submitting order...</div>
            <div class="success-message" id="successMessage">‚úì Order submitted successfully!</div>
            <div class="error-message" id="errorMessage">‚úó Failed to submit. Please check your input.</div>
            <div class="info-message" id="infoMessage">‚Ñπ Processing...</div>
        </div>

        <!-- MY ORDERS VIEW -->
        <div id="myOrdersView" class="view">
            <div class="filter-section">
                <input type="text" id="searchClient" placeholder="Search by client name..." onkeyup="filterOrders()">
                <select id="filterStatus" onchange="filterOrders()">
                    <option value="">All Status</option>
                    <option value="Production">Production</option>
                    <option value="Stitching">Stitching</option>
                    <option value="Delivered">Delivered</option>
                </select>
                <select id="filterDress" onchange="filterOrders()">
                    <option value="">All Dresses</option>
                    <option value="Nur">Nur</option>
                    <option value="Mehr">Mehr</option>
                    <option value="Hala">Hala</option>
                </select>
            </div>

            <div class="orders-table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Dress</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Advance</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="ordersLoading" style="text-align: center; padding: 40px; color: #666;">
                Loading orders...
            </div>

            <div id="noOrders" style="text-align: center; padding: 40px; color: #666; display: none;">
                No orders found
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="view">
            <div class="dashboard-controls">
                <select id="timeFilter" onchange="updateDashboard()">
                    <option value="all">All Time</option>
                    <option value="month">This Month</option>
                    <option value="4months">Last 4 Months</option>
                    <option value="year">This Year</option>
                </select>
                <select id="viewType" onchange="updateDashboard()">
                    <option value="overview">Overview</option>
                    <option value="byDress">By Dress</option>
                </select>
                <button class="btn" onclick="loadDashboard()">Refresh</button>
                <button class="btn btn-secondary" onclick="openProfitSettings()">‚öôÔ∏è Price & Profit Settings</button>
            </div>

            <div id="statsContainer"></div>
            <div id="chartsContainer"></div>

            <div class="expense-section">
                <h3>
                    Other Expenses
                    <button class="add-expense-btn" onclick="openExpenseModal()">+</button>
                </h3>
                <div class="expense-list" id="expenseList"></div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Expense</h2>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Marketing, Influencer payment" required>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount (PKR)</label>
                    <input type="number" id="expenseAmount" placeholder="0" required min="0">
                </div>
                <button type="submit" class="btn">Add Expense</button>
            </form>
        </div>
    </div>

    <!-- Profit Settings Modal -->
    <div class="modal" id="profitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Price & Profit Margin Settings</h2>
                <button class="close-btn" onclick="closeProfitSettings()">&times;</button>
            </div>
            <div id="settingsContainer"></div>
            <button class="btn" onclick="saveProfitSettings()">Save All Settings</button>
        </div>
    </div>

    <script>
        // -----------------------------
        // Configuration
        // -----------------------------
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzNmmFgfL-GLSjCjSQEP74sRHlIRinjT4QqiZ9hwtH_dycc8UwSA0bJ4qxHg26qdw1FDg/exec';

        // State
        let ordersData = [];
        let expensesData = [];
        let settingsData = [];
        let charts = {};
        let orderItemCount = 0;
        let allOrdersData = [];

        // DOM-ready initialization
        document.getElementById('orderDate').valueAsDate = new Date();
        document.getElementById('expenseDate').valueAsDate = new Date();

        // Add first order item by default
        addOrderItem();
        loadAllSettings();

        // -----------------------------
        // Helper UI message functions
        // -----------------------------
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn('Missing element for message:', elementId);
                return;
            }
            element.textContent = message;
            element.classList.add('show');
            setTimeout(() => element.classList.remove('show'), 3000);
        }
        function hideMessages() {
            ['successMessage', 'errorMessage', 'infoMessage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('show');
            });
        }
        function showSuccessMessage(msg) { showMessage('successMessage', msg); }
        function showErrorMessage(msg) { showMessage('errorMessage', msg); }
        function showInfoMessage(msg) { showMessage('infoMessage', msg); }

        // -----------------------------
        // Settings load / helpers
        // -----------------------------
        async function loadAllSettings() {
            try {
                const resp = await fetch(SCRIPT_URL + '?action=getSettings');
                // If script is deployed without CORS, fetch may fail; handle gracefully:
                const data = await resp.json();
                if (data.status === 'success' && Array.isArray(data.settings) && data.settings.length > 0) {
                    settingsData = data.settings;
                } else {
                    // defaults
                    const today = new Date().toISOString().split('T')[0];
                    settingsData = [
                        { 'Dress Name': 'Nur', 'Price': 15000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' },
                        { 'Dress Name': 'Mehr', 'Price': 18000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' },
                        { 'Dress Name': 'Hala', 'Price': 20000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' }
                    ];
                }
            } catch (err) {
                console.warn('Could not fetch settings (using defaults):', err);
                const today = new Date().toISOString().split('T')[0];
                settingsData = [
                    { 'Dress Name': 'Nur', 'Price': 15000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' },
                    { 'Dress Name': 'Mehr', 'Price': 18000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' },
                    { 'Dress Name': 'Hala', 'Price': 20000, 'Price Start Date': today, 'Price End Date': '', 'Profit Margin': 4000, 'Profit Start Date': today, 'Profit End Date': '' }
                ];
            }
        }

        // Robust getters for price/profit: handle different casing from server
        function getField(obj, names) {
            for (const n of names) {
                if (obj[n] !== undefined && obj[n] !== null && obj[n] !== '') return obj[n];
            }
            return undefined;
        }

        function getCurrentPrice(dressName, orderDate) {
            const dress = settingsData.find(s => (getField(s, ['Dress Name', 'dressName', 'dress name']) || '') === dressName);
            if (!dress) return 0;
            try {
                const date = new Date(orderDate);
                const startDate = new Date(getField(dress, ['Price Start Date', 'priceStartDate']) || new Date(0));
                const endVal = getField(dress, ['Price End Date', 'priceEndDate']);
                const endDate = endVal ? new Date(endVal) : null;
                const priceVal = parseFloat(getField(dress, ['Price', 'price'])) || 0;
                if (date >= startDate && (!endDate || date <= endDate)) return priceVal;
                return priceVal;
            } catch (e) {
                return parseFloat(getField(dress, ['Price', 'price'])) || 0;
            }
        }

        function getCurrentProfit(dressName, orderDate) {
            const dress = settingsData.find(s => (getField(s, ['Dress Name', 'dressName', 'dress name']) || '') === dressName);
            if (!dress) return 4000;
            try {
                const date = new Date(orderDate);
                const startDate = new Date(getField(dress, ['Profit Start Date', 'profitStartDate']) || new Date(0));
                const endVal = getField(dress, ['Profit End Date', 'profitEndDate']);
                const endDate = endVal ? new Date(endVal) : null;
                const profitVal = parseFloat(getField(dress, ['Profit Margin', 'profitMargin'])) || 4000;
                if (date >= startDate && (!endDate || date <= endDate)) return profitVal;
                return profitVal;
            } catch (e) {
                return parseFloat(getField(dress, ['Profit Margin', 'profitMargin'])) || 4000;
            }
        }

        // -----------------------------
        // Order item UI
        // -----------------------------
        function addOrderItem() {
            orderItemCount++;
            const container = document.getElementById('orderItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'order-item';
            itemDiv.id = `item-${orderItemCount}`;

            itemDiv.innerHTML = `
                <h4>
                    Item ${orderItemCount}
                    ${orderItemCount > 1 ? `<button type="button" class="remove-item-btn" onclick="removeOrderItem(${orderItemCount})">Remove</button>` : ''}
                </h4>
                <div class="form-group">
                    <label>Dress Name</label>
                    <select class="item-dress" required onchange="updateItemPrice(${orderItemCount})">
                        <option value="">Select a dress</option>
                        <option value="Nur">Nur</option>
                        <option value="Mehr">Mehr</option>
                        <option value="Hala">Hala</option>
                    </select>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Unit Price (PKR)</label>
                        <input type="number" class="item-price" placeholder="Auto-filled" readonly required>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="item-quantity" value="1" min="1" required>
                    </div>
                </div>
            `;

            container.appendChild(itemDiv);
            showInfoMessage('‚ûï New item added - Select a dress');
        }

        function removeOrderItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.remove();
                showInfoMessage('üóëÔ∏è Item removed');
            }
        }

        // Update a single item price based on settings and the order date
        function updateItemPrice(id) {
            const item = document.getElementById(`item-${id}`);
            if (!item) return;
            const dressSelect = item.querySelector('.item-dress');
            const priceInput = item.querySelector('.item-price');
            const orderDate = document.getElementById('orderDate').value;

            if (dressSelect && priceInput && dressSelect.value && orderDate) {
                const price = getCurrentPrice(dressSelect.value, orderDate);
                priceInput.value = isNaN(price) ? '' : Number(price);
                // Friendly message (not too spammy)
                if (priceInput.value) showInfoMessage(`üí∞ Price updated: ‚Ç®${Number(price).toLocaleString()} for ${dressSelect.value}`);
            }
        }

        // Update all item prices when order date changes (keeps prices in sync)
        document.getElementById('orderDate').addEventListener('change', () => {
            document.querySelectorAll('.order-item').forEach(el => {
                const id = el.id.split('-')[1];
                updateItemPrice(id);
            });
        });

        // -----------------------------
        // Switch views
        // -----------------------------
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if (view === 'order') {
                document.getElementById('orderView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
                showInfoMessage('üìù New Order Page');
            } else if (view === 'myorders') {
                document.getElementById('myOrdersView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                showInfoMessage('üìã Loading your orders...');
                loadMyOrders();
            } else if (view === 'dashboard') {
                document.getElementById('dashboardView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
                showInfoMessage('üìä Loading dashboard...');
                loadDashboard();
            }
        }

        // -----------------------------
        // Submit order
        // -----------------------------
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');

            // Collect all items
            const items = [];
            const itemElements = document.querySelectorAll('.order-item');

            itemElements.forEach(itemEl => {
                const dress = (itemEl.querySelector('.item-dress') || {}).value;
                const priceVal = (itemEl.querySelector('.item-price') || {}).value;
                const price = priceVal === '' ? 0 : parseFloat(priceVal);
                const qtyVal = (itemEl.querySelector('.item-quantity') || {}).value;
                const quantity = qtyVal === '' ? 0 : parseInt(qtyVal);

                if (dress && typeof price === 'number' && quantity > 0) {
                    items.push({ dressName: dress, price: price, quantity: quantity, advancePayment: 0 });
                }
            });

            if (items.length === 0) {
                showErrorMessage('‚ùå Please add at least one item!');
                return;
            }

            const advancePayment = parseFloat(document.getElementById('advancePayment').value) || 0;
            const totalAmount = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (advancePayment > totalAmount) {
                showErrorMessage('‚ùå Advance payment cannot exceed total amount!');
                return;
            }

            // Distribute advance payment across items proportionally
            items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                item.advancePayment = totalAmount > 0 ? ((itemTotal / totalAmount) * advancePayment) : 0;
            });

            const clientName = document.getElementById('clientName').value;

            const formData = {
                type: 'order',
                date: document.getElementById('orderDate').value,
                clientName: clientName,
                items: items
            };

            submitBtn.disabled = true;
            loading.classList.add('show');
            hideMessages();

            try {
                // NOTE: mode:'no-cors' returns an opaque response and prevents reading body.
                // You can remove 'no-cors' after enabling proper CORS on the Apps Script web app (recommended).
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                loading.classList.remove('show');
                showSuccessMessage(`‚úì Order for ${clientName} submitted successfully! ${items.length} item(s) added.`);

                document.getElementById('orderForm').reset();
                document.getElementById('orderDate').valueAsDate = new Date();

                // Reset items
                document.getElementById('orderItems').innerHTML = '<h3 style="margin-bottom: 15px; color: #333;">Order Items</h3>';
                orderItemCount = 0;
                addOrderItem();

            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('show');
                showErrorMessage('‚úó Failed to submit order. Please try again.');
            } finally {
                submitBtn.disabled = false;
            }
        });

        // -----------------------------
        // Expense modal & submit
        // -----------------------------
        function openExpenseModal() {
            document.getElementById('expenseModal').classList.add('show');
            showInfoMessage('üíµ Add a new expense');
        }
        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('show');
            showInfoMessage('‚ùå Expense form closed');
        }

        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;

            const expenseData = {
                type: 'expense',
                date: document.getElementById('expenseDate').value,
                description: description,
                amount: amount
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });

                showSuccessMessage(`‚úì Expense added: ${description} - ‚Ç®${amount.toLocaleString()}`);
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').valueAsDate = new Date();
                closeExpenseModal();
                setTimeout(() => loadDashboard(), 500);
            } catch (error) {
                console.error('Error:', error);
                showErrorMessage('‚úó Failed to add expense. Please try again.');
            }
        });

        // -----------------------------
        // Dashboard & charts
        // -----------------------------
        async function loadDashboard() {
            try {
                showInfoMessage('üìä Refreshing dashboard data...');

                const ordersResponse = await fetch(SCRIPT_URL + '?action=getOrders');
                const ordersResult = await ordersResponse.json();
                if (ordersResult.status === 'success') {
                    ordersData = ordersResult.orders || [];
                } else {
                    ordersData = [];
                }

                const expensesResponse = await fetch(SCRIPT_URL + '?action=getExpenses');
                const expensesResult = await expensesResponse.json();
                if (expensesResult.status === 'success') {
                    expensesData = expensesResult.expenses || [];
                } else {
                    expensesData = [];
                }

                updateExpenseList();
                updateDashboard();
                showSuccessMessage('‚úì Dashboard updated successfully!');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showErrorMessage('‚úó Failed to load dashboard data');
            }
        }

        function updateExpenseList() {
            const list = document.getElementById('expenseList');
            if (!expensesData || expensesData.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No expenses recorded yet</p>';
                return;
            }

            const sortedExpenses = [...expensesData].sort((a, b) => new Date(b.Date || b.date) - new Date(a.Date || a.date));
            list.innerHTML = sortedExpenses.map(expense => `
                <div class="expense-item">
                    <div class="expense-info">
                        <div class="expense-date">${expense.Date || expense.date || 'N/A'}</div>
                        <div class="expense-description">${expense.Description || expense.description || 'No description'}</div>
                    </div>
                    <div class="expense-amount">‚Ç®${(parseFloat(expense.Amount || expense.amount) || 0).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function updateDashboard() {
            const timeFilter = document.getElementById('timeFilter').value;
            const viewType = document.getElementById('viewType').value;

            const filteredOrders = filterOrdersByTime(ordersData, timeFilter);
            const filteredExpenses = filterOrdersByTime(expensesData, timeFilter);

            if (viewType === 'overview') {
                showOverview(filteredOrders, filteredExpenses);
            } else {
                showByDress(filteredOrders);
            }
        }

        function filterOrdersByTime(items, filter) {
            if (filter === 'all' || !items || items.length === 0) return items || [];

            const now = new Date();
            return items.filter(item => {
                const itemDate = new Date(item.Date || item.date || 0);

                if (filter === 'month') {
                    return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
                } else if (filter === '4months') {
                    const fourMonthsAgo = new Date();
                    fourMonthsAgo.setMonth(now.getMonth() - 4);
                    return itemDate >= fourMonthsAgo;
                } else if (filter === 'year') {
                    return itemDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }

        function showOverview(orders, expenses) {
            let totalSales = 0;
            let totalProfit = 0;
            let totalOrders = 0;
            let totalExpenses = 0;

            const uniqueOrders = new Set();

            orders.forEach(order => {
                const totalAmount = parseFloat(order['Total Amount'] || order['Total amount'] || order['Price'] || order['price'] || 0) || 0;
                const quantity = parseInt(order['Quantity'] || order['quantity'] || 1) || 1;
                const dressName = order['Dress Name'] || order['dress name'] || order['dressName'] || '';
                const orderDate = order['Date'] || order['date'] || '';
                const profitMargin = getCurrentProfit(dressName, orderDate);

                totalSales += totalAmount;
                totalProfit += (profitMargin * quantity);

                const orderId = order['Order ID'] || order['orderId'] || (orderDate + (order['Client Name'] || order['clientName'] || ''));
                uniqueOrders.add(orderId);
            });

            totalOrders = uniqueOrders.size;

            expenses.forEach(expense => {
                totalExpenses += parseFloat(expense.Amount || expense.amount || 0) || 0;
            });

            const netProfit = totalProfit - totalExpenses;

            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalOrders}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç®${Math.round(totalSales).toLocaleString()}</div>
                        <div class="stat-label">Total Sales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç®${Math.round(totalExpenses).toLocaleString()}</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç®${Math.round(netProfit).toLocaleString()}</div>
                        <div class="stat-label">Net Profit</div>
                    </div>
                </div>
            `;

            renderOverviewCharts(orders, expenses);
        }

        function showByDress(orders) {
            const dressSummary = {};

            orders.forEach(order => {
                const dress = order['Dress Name'] || order['dressName'] || order['dress name'] || 'Unknown';
                if (!dressSummary[dress]) {
                    dressSummary[dress] = { count: 0, sales: 0, profit: 0 };
                }

                const totalAmount = parseFloat(order['Total Amount'] || order['Price'] || order['price'] || 0) || 0;
                const quantity = parseInt(order['Quantity'] || order['quantity'] || 1) || 1;
                const profitMargin = getCurrentProfit(dress, order['Date'] || order['date'] || '');

                dressSummary[dress].count += quantity;
                dressSummary[dress].sales += totalAmount;
                dressSummary[dress].profit += (profitMargin * quantity);
            });

            let statsHTML = '<div class="stats-grid">';
            Object.keys(dressSummary).forEach(dress => {
                const data = dressSummary[dress];
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${dress}</div>
                        <div class="stat-label">${data.count} items sold</div>
                        <div class="stat-label">Sales: ‚Ç®${Math.round(data.sales).toLocaleString()}</div>
                        <div class="stat-label">Profit: ‚Ç®${Math.round(data.profit).toLocaleString()}</div>
                    </div>
                `;
            });
            statsHTML += '</div>';

            document.getElementById('statsContainer').innerHTML = statsHTML;
            renderDressCharts(dressSummary);
        }

        function renderOverviewCharts(orders, expenses) {
            const chartsContainer = document.getElementById('chartsContainer');
            chartsContainer.innerHTML = `
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            `;

            if (charts.salesChart) { charts.salesChart.destroy(); charts.salesChart = null; }
            if (charts.expenseChart) { charts.expenseChart.destroy(); charts.expenseChart = null; }

            const dressCounts = {};
            orders.forEach(order => {
                const dress = order['Dress Name'] || order['dressName'] || order['dress name'];
                const quantity = parseInt(order['Quantity'] || order['quantity'] || 1) || 1;
                if (dress) dressCounts[dress] = (dressCounts[dress] || 0) + quantity;
            });

            const ctx1 = document.getElementById('salesChart');
            if (ctx1 && Object.keys(dressCounts).length > 0) {
                charts.salesChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dressCounts),
                        datasets: [{
                            label: 'Items Sold by Dress',
                            data: Object.values(dressCounts),
                            backgroundColor: ['#C4A574', '#8B7355', '#A0826D']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: true }, title: { display: true, text: 'Items Sold by Dress Type' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            } else if (ctx1) {
                ctx1.parentElement.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">No sales data to display</p>';
            }

            const ctx2 = document.getElementById('expenseChart');
            if (ctx2 && expenses && expenses.length > 0) {
                const sortedExpenses = [...expenses].sort((a, b) => new Date(a.Date || a.date) - new Date(b.Date || b.date));
                charts.expenseChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: sortedExpenses.map(e => e.Date || e.date || 'N/A'),
                        datasets: [{
                            label: 'Expenses (PKR)',
                            data: sortedExpenses.map(e => parseFloat(e.Amount || e.amount) || 0),
                            borderColor: '#C4A574',
                            backgroundColor: 'rgba(196, 165, 116, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: true }, title: { display: true, text: 'Expenses Over Time' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } else if (ctx2) {
                ctx2.parentElement.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">No expenses to display</p>';
            }
        }

        function renderDressCharts(dressSummary) {
            const chartsContainer = document.getElementById('chartsContainer');
            chartsContainer.innerHTML = `<div class="chart-container"><canvas id="dressChart"></canvas></div>`;

            if (charts.dressChart) { charts.dressChart.destroy(); charts.dressChart = null; }

            const ctx = document.getElementById('dressChart');
            if (ctx && Object.keys(dressSummary).length > 0) {
                charts.dressChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dressSummary),
                        datasets: [{
                            label: 'Sales (PKR)',
                            data: Object.keys(dressSummary).map(d => dressSummary[d].sales),
                            backgroundColor: '#C4A574'
                        }, {
                            label: 'Profit (PKR)',
                            data: Object.keys(dressSummary).map(d => dressSummary[d].profit),
                            backgroundColor: '#8B7355'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: true }, title: { display: true, text: 'Sales & Profit by Dress' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            } else if (ctx) {
                ctx.parentElement.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">No data to display</p>';
            }
        }

        // -----------------------------
        // Settings modal and save
        // -----------------------------
        function openProfitSettings() {
            renderSettingsForm();
            document.getElementById('profitModal').classList.add('show');
            showInfoMessage('‚öôÔ∏è Profit & Price Settings opened');
        }
        function closeProfitSettings() {
            document.getElementById('profitModal').classList.remove('show');
            showInfoMessage('‚ùå Settings closed');
        }

        function renderSettingsForm() {
            const container = document.getElementById('settingsContainer');
            let html = '';

            ['Nur', 'Mehr', 'Hala'].forEach(dressName => {
                const existing = settingsData.find(s => (getField(s, ['Dress Name', 'dressName', 'dress name']) || '') === dressName) || {};
                const today = new Date().toISOString().split('T')[0];

                const priceData = existing;
                const profitData = existing;

                html += `
                    <div class="settings-row">
                        <h4>${dressName}</h4>
                        <div class="form-group">
                            <label>Price (PKR)</label>
                            <input type="number" class="dress-price" data-dress="${dressName}" value="${(getField(priceData, ['Price','price'])||0)}">
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>Price Start Date</label>
                                <input type="date" class="price-start" data-dress="${dressName}" value="${(getField(priceData, ['Price Start Date','priceStartDate'])||today)}">
                            </div>
                            <div class="form-group">
                                <label>Price End Date</label>
                                <input type="date" class="price-end" data-dress="${dressName}" value="${(getField(priceData, ['Price End Date','priceEndDate'])||'')}">
                                <div class="checkbox-group">
                                    <input type="checkbox" class="price-no-end" data-dress="${dressName}" ${!getField(priceData, ['Price End Date','priceEndDate']) ? 'checked' : ''}>
                                    <label style="margin:0;">No end date</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Profit Margin (PKR)</label>
                            <input type="number" class="dress-profit" data-dress="${dressName}" value="${(getField(profitData, ['Profit Margin','profitMargin'])||4000)}">
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>Profit Start Date</label>
                                <input type="date" class="profit-start" data-dress="${dressName}" value="${(getField(profitData, ['Profit Start Date','profitStartDate'])||today)}">
                            </div>
                            <div class="form-group">
                                <label>Profit End Date</label>
                                <input type="date" class="profit-end" data-dress="${dressName}" value="${(getField(profitData, ['Profit End Date','profitEndDate'])||'')}">
                                <div class="checkbox-group">
                                    <input type="checkbox" class="profit-no-end" data-dress="${dressName}" ${!getField(profitData, ['Profit End Date','profitEndDate']) ? 'checked' : ''}>
                                    <label style="margin:0;">No end date</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Add event listeners for checkboxes
            document.querySelectorAll('.price-no-end, .profit-no-end').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const dress = this.dataset.dress;
                    const isPrice = this.classList.contains('price-no-end');
                    const dateInput = document.querySelector(`.${isPrice ? 'price' : 'profit'}-end[data-dress="${dress}"]`);
                    if (!dateInput) return;
                    dateInput.disabled = this.checked;
                    if (this.checked) dateInput.value = '';
                });
            });
        }

        async function saveProfitSettings() {
            const settings = [];

            ['Nur', 'Mehr', 'Hala'].forEach(dressName => {
                const price = document.querySelector(`.dress-price[data-dress="${dressName}"]`).value;
                const priceStart = document.querySelector(`.price-start[data-dress="${dressName}"]`).value;
                const priceEnd = document.querySelector(`.price-end[data-dress="${dressName}"]`).value;
                const profit = document.querySelector(`.dress-profit[data-dress="${dressName}"]`).value;
                const profitStart = document.querySelector(`.profit-start[data-dress="${dressName}"]`).value;
                const profitEnd = document.querySelector(`.profit-end[data-dress="${dressName}"]`).value;

                settings.push({
                    dressName: dressName,
                    price: parseFloat(price) || 0,
                    priceStartDate: priceStart,
                    priceEndDate: priceEnd || '',
                    profitMargin: parseFloat(profit) || 0,
                    profitStartDate: profitStart,
                    profitEndDate: profitEnd || ''
                });
            });

            try {
                showInfoMessage('üíæ Saving settings...');

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // see note above about CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'updateSettings', settings: settings })
                });

                showSuccessMessage('‚úì Price & Profit settings saved successfully!');
                closeProfitSettings();
                await loadAllSettings();
                updateDashboard();
            } catch (error) {
                console.error('Error saving:', error);
                showErrorMessage('‚úó Failed to save settings. Please try again.');
            }
        }

        // -----------------------------
        // My Orders: load / display / update
        // -----------------------------
        async function loadMyOrders() {
            document.getElementById('ordersLoading').style.display = 'block';
            document.getElementById('noOrders').style.display = 'none';

            try {
                const response = await fetch(SCRIPT_URL + '?action=getOrders');
                const data = await response.json();

                if (data.status === 'success') {
                    allOrdersData = data.orders || [];
                    displayOrders(allOrdersData);
                    showSuccessMessage(`‚úì Loaded ${allOrdersData.length} order(s)`);
                } else {
                    allOrdersData = [];
                    displayOrders([]);
                    showErrorMessage('‚úó No orders available');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersLoading').innerHTML = '<p style="color: #f44336;">Failed to load orders</p>';
                showErrorMessage('‚úó Failed to load orders');
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            document.getElementById('ordersLoading').style.display = 'none';

            if (!orders || orders.length === 0) {
                document.getElementById('noOrders').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            document.getElementById('noOrders').style.display = 'none';

            // Sort by date (newest first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.Date || b.date) - new Date(a.Date || a.date));

            tbody.innerHTML = sortedOrders.map((order, index) => {
                const orderId = order['Order ID'] || order['orderId'] || `ORD-${String(index + 1).padStart(4, '0')}`;
                const status = order['Status'] || order['status'] || 'Production';
                const totalAmount = parseFloat(order['Total Amount'] || order['Price'] || order['price'] || 0) || 0;
                const quantity = parseInt(order['Quantity'] || order['quantity'] || 1) || 1;
                const advancePayment = parseFloat(order['Advance Payment'] || order['advancePayment'] || 0) || 0;
                const remainingAmount = parseFloat(order['Remaining Amount'] || order['remainingAmount'] || 0) || 0;

                return `
                    <tr data-order-id="${orderId}">
                        <td><span class="order-id">${orderId}</span></td>
                        <td>${order.Date || order.date || 'N/A'}</td>
                        <td>${order['Client Name'] || order['clientName'] || 'N/A'}</td>
                        <td>${order['Dress Name'] || order['dressName'] || 'N/A'}</td>
                        <td>${quantity}</td>
                        <td>‚Ç®${Math.round(totalAmount).toLocaleString()}</td>
                        <td>‚Ç®${Math.round(advancePayment).toLocaleString()}</td>
                        <td>
                            <input type="number" 
                                   class="remaining-input" 
                                   value="${Math.round(remainingAmount)}" 
                                   data-order-id="${orderId}"
                                   style="width: 100px;">
                        </td>
                        <td>
                            <select class="status-select" data-order-id="${orderId}">
                                <option value="Production" ${status === 'Production' ? 'selected' : ''}>Production</option>
                                <option value="Stitching" ${status === 'Stitching' ? 'selected' : ''}>Stitching</option>
                                <option value="Delivered" ${status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>
                            <button class="save-order-btn" onclick="updateOrder('${orderId.replace(/'/g, "\\'")}')">Save</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateOrder(orderId) {
            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (!row) return showErrorMessage('‚úó Order row not found');

            const status = row.querySelector('.status-select').value;
            const remainingAmount = parseFloat(row.querySelector('.remaining-input').value) || 0;

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'updateOrder',
                        orderId: orderId,
                        status: status,
                        remainingAmount: remainingAmount
                    })
                });

                showMessage('successMessage', `‚úì Order ${orderId} updated successfully!`);

                // Update local data
                const orderIndex = allOrdersData.findIndex(o => (o['Order ID'] || o['orderId']) === orderId);
                if (orderIndex !== -1) {
                    allOrdersData[orderIndex]['Status'] = status;
                    allOrdersData[orderIndex]['Remaining Amount'] = remainingAmount;
                }

            } catch (error) {
                console.error('Error updating order:', error);
                showMessage('errorMessage', '‚úó Failed to update order');
            }
        }

        function filterOrders() {
            const searchText = document.getElementById('searchClient').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const dressFilter = document.getElementById('filterDress').value;

            const filtered = (allOrdersData || []).filter(order => {
                const matchesSearch = !searchText || ( (order['Client Name'] || order['clientName'] || '').toLowerCase().includes(searchText) );
                const matchesStatus = !statusFilter || (order['Status'] === statusFilter || order['status'] === statusFilter);
                const matchesDress = !dressFilter || (order['Dress Name'] === dressFilter || order['dressName'] === dressFilter);
                return matchesSearch && matchesStatus && matchesDress;
            });

            displayOrders(filtered);
        }

        // -----------------------------
        // Initial small helpers
        // -----------------------------
        // Add event listener for Enter key in modal forms to prevent accidental submits
        document.querySelectorAll('.modal input').forEach(inp => {
            inp.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') e.stopPropagation();
            });
        });

    </script>
</body>
</html>
